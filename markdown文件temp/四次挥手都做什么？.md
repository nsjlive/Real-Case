

#### 四次挥手都做什么？

TCP的连接是全双工的，所以连接的拆除需要单独将两个通道分别拆除，而四次挥手所做的事情就是**拆除两条通道**和**释放资源**。

TCP 提供了连接的一端结束它的发送后，还能**接收来自另一端数据的能力**，也就是所谓的半关闭。

#### 为什么需要四次挥手？

因为TCP是一个全双工协议，必须**单独拆除每一条信道**。4次挥手的目的是**终止数据传输**，**并回收资源**，此时两个端点两个方向的序列号已经没有了任何关系，**必须等待两方向都没有数据传输时才能拆除虚链路**，不像初始化时那么简单，发现SYN标志就初始化一个序列号并确认SYN的序列号。因此**必须单独分别在一个方向上终止该方向的数据传输**。

如果是三次挥手，会怎么样？三次的话，被动关闭端在收到FIN消息之后，需要同时回复ACK和Server端的FIN消息。如果Server端在该连接上面并没有Pending的消息要处理，那么是可以的，如果Server端还需要等待一段时间才可以关闭另外一个方向的连接，那么这样的三次挥手就不能满足条件。

#### 什么是“3次握手，4次挥手”

TCP是一种**面向连接**的单播协议，在发送数据前，通信双方必须在彼此间建立一条连接。所谓的“**连接**”，其实是客户端和服务器的内存里保存的一份关于对方的信息，如ip地址、端口号等。

TCP可以看成是一种字节流，它会处理IP层或以下的层的丢包、重复以及错误问题。在连接的建立过程中，双方需要交换一些连接的参数。这些参数可以放在TCP头部。

TCP提供了一种可靠、面向连接、字节流、传输层的服务，采用三次握手建立一个连接。采用**4次挥手来关闭一个连接**。，它会处理**IP层或以下的层**的丢包、重复以及错误问题。在连接的建立过程中，双方需要交换一些连接的参数。这些参数可以放在TCP头部。

#### TCP服务模型

在了解了建立连接、关闭连接的“三次握手和四次挥手”后，我们再来看下TCP相关的东西。

一个TCP连接由一个4元组构成，分别是两个IP地址和两个端口号。一个TCP连接通常分为三个阶段：启动、数据传输、退出（关闭）。

当TCP接收到另一端的数据时，它会发送一个确认，但这个确认不会立即发送，一般会延迟一会儿。ACK是累积的，一个确认字节号N的ACK表示所有直到N的字节（不包括N）已经成功被接收了。这样的好处是如果一个ACK丢失，很可能后续的ACK就足以确认前面的报文段了。

一个完整的TCP连接是**双向和对称**的，数据可以在两个方向上平等地流动。给上层应用程序提供一种`双工服务`。一旦建立了一个连接，这个连接的一个方向上的每个TCP报文段都包含了相反方向上的报文段的一个ACK。

**序列号**的作用是使得一个TCP接收端**可丢弃重复的报文段**，记录以杂乱次序到达的报文段。因为TCP**使用IP来传输报文段**，而IP不提供重复消除或者保证次序正确的功能。另一方面，TCP是一个字节流协议，绝不会以杂乱的次序给上层程序发送数据。因此**TCP接收端会被迫先保持大序列号的数据不交给应用程序**，直到缺失的小序列号的报文段被填满。

**源端口和目的端口**在TCP层确定双方进程，**序列号**表示的是报文段数据中的**第一个字节号**，**ACK**表示确认号，该确认号的发送方期待接收的下一个序列号，即**最后被成功接收的数据字节序列号加1**，这个字段只有在ACK位被启用的时候才有效。

当新建一个连接时，从客户端发送到服务端的第一个报文段的SYN位被启用，这称为SYN报文段，这时序列号字段**包含**了在本次连接的这个方向上要使用的第一个序列号，即初始序列号`ISN`，**之后发送的数据是ISN加1**，因此SYN位字段会`消耗`一个序列号，这意味着使用重传进行可靠传输。而不消耗序列号的ACK则不是。

头部长度（图中的数据偏移）以32位字为单位，也就是以4bytes为单位，它只有4位，最大为15，因此头部最大长度为60字节，而其最小为5，也就是头部最小为20字节（**可变选项为空**）。

ACK —— 确认，使得确认号有效。 RST —— 重置连接（经常看到的reset by peer）就是此字段搞的鬼。 **SYN —— 用于初如化一个连接的序列号**。 **FIN —— 该报文段的发送方已经结束向对方发送数据。**

当一个连接被建立或被终止时，交换的报文段只包含TCP头部，而没有数据。

#### 四次挥手

TCP连接是双向传输的对等的模式，就是说双方都可以同时向对方发送或接收数据。当有**一方**要关闭连接时，会发送指令告知**对方**，我要关闭连接了。这时对方会回一个ACK，此时一个方向的连接关闭。

但是**另一个方向仍然可以继续传输数据**，等到发送完了所有的数据后，会发送一个FIN段来关闭此方向上的连接。接收方发送ACK确认关闭连接。注意，接收到FIN报文的一方只能回复一个ACK, 它是无法马上返回对方一个FIN报文段的，因为结束数据传输的“指令”是上层应用层给出的，我只是一个“搬运工”，我无法了解`“上层的意志”`。





